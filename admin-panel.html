<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - ZentroMall</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6" onload="checkLogin(); loadOrders(); loadProducts(); loadBanners()">

  <div class="max-w-7xl mx-auto">
    <h1 class="text-5xl font-bold text-center mb-8 text-yellow-400">ADMIN PANEL</h1>
    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg mb-6 float-right">Logout</button>

    <!-- Add Product -->
    <div class="bg-gray-800 rounded-2xl p-8 mb-8">
      <h2 class="text-3xl font-bold text-green-400 mb-6">Add New Product</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <input id="pName" placeholder="Product Name" class="p-4 rounded bg-gray-700">
        <input id="pPrice" type="number" placeholder="Price (PKR)" class="p-4 rounded bg-gray-700">
        <input id="pDesc" placeholder="Description" class="p-4 rounded bg-gray-700">
      </div>
      <input type="file" id="pImage" accept="image/*,video/*" class="p-4 bg-gray-700 text-white w-full mb-4">
      <button onclick="addProduct()" class="w-full bg-indigo-600 hover:bg-indigo-700 py-5 rounded-xl text-2xl font-bold">
        ADD PRODUCT
      </button>
    </div>

    <!-- Show All Products -->
    <h2 class="text-3xl font-bold mb-6 text-cyan-400">All Products (${products.length})</h2>
    <div id="productList" class="grid grid-cols-2 md:grid-cols-4 gap-8 mb-12"></div>

    <!-- Orders History -->
    <div class="bg-gray-800 rounded-2xl p-8">
      <h2 class="text-3xl font-bold mb-6 text-orange-400">Order History</h2>
      <button onclick="exportToExcel()" class="bg-blue-600 px-6 py-3 rounded mb-4">Export Excel</button>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-700">
            <tr>
              <th>#</th><th>Date</th><th>Name</th><th>Phone</th><th>Items</th><th>Total</th><th>Status</th><th>Tracking ID</th><th>Action</th>
            </tr>
          </thead>
          <tbody id="orderBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="main.js"></script>
  <script>
    function checkLogin() {
      if (localStorage.getItem("zm_admin_logged") !== "true") {
        alert("Please login first!");
        location.href = "admin.html";
      }
    }
    function logout() {
      localStorage.removeItem("zm_admin_logged");
      location.href = "admin.html";
    }

    // Show Products (اب دکھائی دیں گی!)
    function loadProducts() {
      const list = document.getElementById("productList");
      list.innerHTML = "";
      if (products.length === 0) {
        list.innerHTML = "<p class='text-center text-2xl text-gray-500 col-span-4'>No products added yet</p>";
        return;
      }
      products.forEach(p => {
        list.innerHTML += `
          <div class="bg-gray-700 rounded-xl p-6 text-center shadow-xl">
            ${p.image.startsWith('data:video') ? 
              `<video src="${p.image}" class="w-full h-48 object-cover rounded mb-4" controls></video>` :
              `<img src="${p.image}" class="w-full h-48 object-cover rounded mb-4">`
            }
            <h3 class="text-xl font-bold mb-2">${p.name}</h3>
            <p class="text-green-400 text-2xl font-bold mb-2">${formatPrice(p.price)}</p>
            <p class="text-sm text-gray-300 mb-4">${p.desc}</p>
            <button onclick="deleteProduct(${p.id})" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded w-full font-bold">
              Delete
            </button>
          </div>`;
      });
    }

    // Add Product (اب فوراً دکھے گا)
    function addProduct() {
      const name = document.getElementById("pName").value.trim();
      const price = Number(document.getElementById("pPrice").value);
      const desc = document.getElementById("pDesc").value.trim();
      const file = document.getElementById("pImage").files[0];

      if (!name || !price) {
        alert("Name and Price are required!");
        return;
      }

      if (file) {
        handleImageUpload({target: {files: [file]}}, (mediaData) => {
          const newId = products.length ? Math.max(...products.map(p => p.id)) + 1 : 1;
          products.push({id: newId, name, price, image: mediaData, desc});
          saveData();
          alert("Product Added Successfully!");
          loadProducts();
          clearForm();
        });
      } else {
        const newId = products.length ? Math.max(...products.map(p => p.id)) + 1 : 1;
        products.push({id: newId, name, price, image: "https://via.placeholder.com/300", desc});
        saveData();
        alert("Product Added (with default image)!");
        loadProducts();
        clearForm();
      }
    }

    function deleteProduct(id) {
      if (confirm("Delete this product permanently?")) {
        products = products.filter(p => p.id !== id);
        saveData();
        loadProducts();
      }
    }

    function clearForm() {
      document.getElementById("pName").value = "";
      document.getElementById("pPrice").value = "";
      document.getElementById("pDesc").value = "";
      document.getElementById("pImage").value = "";
    }

    // Orders (پہلے جیسا ہی)
    function loadOrders() {
      const tbody = document.getElementById("orderBody");
      tbody.innerHTML = orders.length === 0 ? "<tr><td colspan='9' class='text-center py-10 text-2xl text-gray-500'>No orders yet</td></tr>" : 
      orders.slice().reverse().map((o, i) => {
        const realIdx = orders.length - 1 - i;
        const items = o.items.map(it => `${it.name || "Unknown"} × ${it.qty}`).join("<br>");
        return `
          <tr class="border-b border-gray-600">
            <td>${orders.length - i}</td>
            <td>${o.date}</td>
            <td>${o.customer.name}</td>
            <td>${o.customer.phone}</td>
            <td>${items}</td>
            <td>${formatPrice(o.total)}</td>
            <td>
              <button onclick="toggleStatus(${realIdx})" class="${o.status==='complete'?'bg-green-600':'bg-yellow-600'} px-6 py-2 rounded">
                ${o.status==='complete'?'Complete':'Pending'}
              </button>
            </td>
            <td>
              <input type="text" value="${o.tracking_id||''}" onchange="saveTracking(${realIdx}, this.value)" class="bg-gray-700 px-4 py-2 rounded w-32">
            </td>
            <td>
              <button onclick="deleteOrder(${realIdx})" class="bg-red-600 px-4 py-2 rounded">Delete</button>
            </td>
          </tr>`;
      }).join("");
    }

    function toggleStatus(i) { orders[i].status = orders[i].status === "complete" ? "pending" : "complete"; saveData(); loadOrders(); }
    function saveTracking(i, val) { orders[i].tracking_id = val.trim(); saveData(); }
    function deleteOrder(i) { if(confirm("Delete?")) { orders.splice(i,1); saveData(); loadOrders(); } }

    function exportToExcel() {
      if(orders.length===0) return alert("No orders!");
      let csv = "No,Date,Name,Phone,Items,Total,Status,Tracking\n";
      orders.forEach((o,i) => {
        const items = o.items.map(it => `${it.name} x${it.qty}`).join(" | ");
        csv += `${i+1},"${o.date}","${o.customer.name}","${o.customer.phone}","${items}","${o.total}","${o.status}","${o.tracking_id||''}"\n`;
      });
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "ZentroMall_Orders.csv";
      link.click();
    }

    // Banners (پہلے جیسا)
    let banners = JSON.parse(localStorage.getItem("zm_banners") || "[]");
    function loadBanners() {
      document.getElementById("bannerList").innerHTML = banners.map((t,i) => `
        <div class="bg-gray-700 p-4 rounded flex justify-between">
          <span>${t}</span>
          <button onclick="banners.splice(i,1); localStorage.setItem('zm_banners',JSON.stringify(banners)); loadBanners()" class="text-red-400">Delete</button>
        </div>
      `).join("") || "<p class='text-gray-500'>No banner</p>";
    }
    function addBanner() {
      const t = document.getElementById("bannerText").value.trim();
      if(t){ banners.push(t); localStorage.setItem("zm_banners", JSON.stringify(banners)); loadBanners(); document.getElementById("bannerText").value=""; }
    }
  </script>
</body>
</html>
